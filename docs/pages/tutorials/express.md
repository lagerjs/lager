---
title: Deploying an Express application in Lambda
keywords: lager, api-gateway, lambda, express
tags: [getting_started, tutorial, api-gateway, lambda]
summary: "In this tutorial, we will see how to deploy an existing Express application in API Gateway and Lambda."
sidebar: home_sidebar
permalink: express.html
folder: tutorials
---

> This tutorial uses `express-generator` to quickly create a sample application. This sample application is not an API and serves static content but we do not
recommend to do that in a real case scenario. You should use `Express` with API Gateway and Lambda only for APIs.

Starting with an Express application
---

We will start by creating a basic Express application following [the documentation](https://expressjs.com/en/starter/generator.html).

```bash
# Installation of express-generator
npm install express-generator -g
# Creation of a basic application
express --view=pug express-app
# Installation of dependencies
cd express-app && npm install
```

We start the application locally to check that everything works correctly.

```bash
set DEBUG=express-app:* & npm start
```

Visit http://127.0.0.1:3000/ to check that the application runs correctly locally.

Adding Lager to the project
---

Be sure that the Lager cli is installed.

```bash
npm install -g @lager/cli
```

### Install Lager in the Express project

```bash
# For the prompt "What is your project name?", leave it empty, so Lager will be installed in the same directory that Express
# We will need the plugins @lager/iam @lager/api-gateway and @lager/lambda
lager new @lager/iam @lager/api-gateway @lager/lambda
```

Lager and its plugins will be installed in the section `devDependencies` of the file `package.json`.

### Creation of IAM roles

We create two IAM roles: one to allow Lambda to write in cloudwatch and the other to allow API Gateway to invoke Lambda.

```bash
lager create-role MyExpressAppLambdaExecution --model LambdaBasicExecutionRole
lager create-role MyExpressAppLambdaInvocation --model APIGatewayLambdaInvocation
```

### Creation of the Lambda

We create a new Lambda managed by Lager.

```bash
lager create-lambda serverless-express --timeout 30 --memory 256 --role MyExpressAppLambdaExecution
```

We have to do a small alteration to the `package.json` of the Express application to tell node that `app.js` is the file that has to be loaded when
`require()` is used.

```json
// in /package.json
{
  "name": "express-app",
  "version": "0.0.0",
  "main": "app.js",
  ...
}
```

In the `package.json` of the Lambda, we define the Express application as a dependency

```bash
# in /lambda/lambdas/serverless-express
npm install ../../.. --save
```

[aws-serverless-express](https://github.com/awslabs/aws-serverless-express) is a npm package that wrap an Express application to process requests from
API Gateway with Lambda integration. We add it as a dependency of our Lambda.

```bash
# in /lambda/lambdas/serverless-express
npm install aws-serverless-express --save
```

Then we can alter the code of `index.js` from the Lambda to correctly expose the handler.

```javascript
// in /lambda/lambdas/serverless-express/index.js
'use strict';
const awsServerlessExpress = require('aws-serverless-express');
const app = require('express-app');
const server = awsServerlessExpress.createServer(app);

exports.handler = (event, context) => awsServerlessExpress.proxy(server, event, context);
```

### Creation of the API

We create an API with two endpoints using `ANY` method and Lambda proxy integration: one to handle the root url, and another for the rest.

```bash
lager create-api serverless-express --title "Serverless Express" --desc "An Express application served by API Gateway and Lambda"
lager create-endpoint / ANY --apis serverless-express --summary "Proxy to Lambda" --auth none --integration lambda-proxy --lambda serverless-express --role MyExpressAppLambdaInvocation
lager create-endpoint /{proxy+} ANY --apis serverless-express --summary "Proxy to Lambda" --auth none --integration lambda-proxy --lambda serverless-express --role MyExpressAppLambdaInvocation
```

### Deployment

```bash
lager deploy-apis serverless-express --region us-east-1 --environment DEV --stage v0 --deploy-lambdas all
```

The deployment messages will give you the url of the application. It will have the form `https://{your-api-id}.execute-api.us-east-1.amazonaws.com/v0`.
You can test the root url and the url `https://{your-api-id}.execute-api.us-east-1.amazonaws.com/v0/users` that is also declared in the sample application
generated by `express-generator`. You can also test some bad urls and observe that you receive an error 404.
